<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Feedback Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'aic-orange': '#F59C00',
              'aic-orange-light': '#FFC34D',
              'aic-orange-dark': '#C77D00',
              'wellness-green': '#00d084',
            },
          },
        },
      };
    </script>
    <link rel="stylesheet" href="/css/navigation.css" />
    <link rel="stylesheet" href="/css/feedback-training-report.css" />
  </head>

  <body>
    <!-- Sticky Header -->
    <header
      class="bg-aic-orange text-white px-8 py-4 shadow-md flex items-center justify-between fixed top-0 left-0 right-0 z-50"
    >
      <div class="flex items-center">
        <a
          href="/"
          class="flex items-center gap-3 cursor-pointer hover:opacity-80 transition-opacity"
        >
          <img
            src="/images/logo-aic-white.svg"
            alt="AIC Logo"
            class="h-10 w-auto"
          />
        </a>
        <div class="ml-8 text-xl font-medium">Training Feedback Report</div>
      </div>
      <button
        onclick="openEmotionStateEngine()"
        class="bg-white text-aic-orange px-4 py-2 rounded-lg font-medium hover:bg-gray-100 transition-colors"
      >
        View Emotion State Engine
      </button>
    </header>

    <div class="report-container" style="padding-top: 80px">
      <div class="report-content">
        <!-- Summary Cards -->
        <!-- Card 1: How You Did -->
        <div class="summary-card" style="margin-bottom: 20px">
          <div class="summary-grid-layout">
            <!-- Left Column: Header Info -->
            <div class="summary-header">
              <h2 class="summary-section-title">Session Information</h2>
              <div class="summary-header-info">
                <p><strong>Trainee:</strong> Freddy Tan</p>
                <p>
                  <strong>Scenario:</strong> Introduction to Advance Care
                  Planning
                </p>
                <p><strong>Date:</strong> 15 December 2025</p>
              </div>
            </div>

            <!-- Right Column: Content -->
            <div class="summary-content">
              <h2 class="summary-section-title">How You Did</h2>
              <div class="summary-goals">
                <div class="overall-result">
                  <strong>Overall Result</strong>
                  <span class="fail-badge-large"
                    >CAN IMPROVE - Review Your Training and Retry</span
                  >
                  <ul class="goals-list">
                    <h3>Scenario Goals</h3>
                    <li>
                      <span class="goal-text"
                        >Practice introducing ACP in a sensitive manner</span
                      >
                      <span class="fail-badge">CAN IMPROVE</span>
                    </li>
                    <li>
                      <span class="goal-text"
                        >Explain ACP benefits clearly and guide senior to book
                        ACP appointment</span
                      >
                      <span class="fail-badge">CAN IMPROVE</span>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Card 2: Persona Emotional Trajectory -->
        <div class="summary-card summary-card-chevron">
          <div class="summary-content">
            <h2 class="summary-section-title">Persona Emotional Trajectory</h2>
            <div class="summary-trajectory">
              <div class="steps">
                <div class="chevron step">
                  <div class="emotional-state-summary-item">
                    <div
                      style="
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        flex-wrap: nowrap;
                        margin-bottom: 8px;
                      "
                    >
                      <svg
                        class="neutral"
                        width="32px"
                        height="32px"
                        viewBox="0 0 44 44"
                        version="1.1"
                        xmlns="http://www.w3.org/2000/svg"
                        xmlns:xlink="http://www.w3.org/1999/xlink"
                      >
                        <g>
                          <circle
                            id="body"
                            fill="#F9AC1B"
                            cx="22"
                            cy="22"
                            r="22"
                          ></circle>
                          <g class="face">
                            <g
                              transform="translate(13.000000, 20.000000)"
                              fill="#2C0E0F"
                            >
                              <g class="mouth">
                                <g transform="translate(9, 5)">
                                  <rect
                                    x="-2"
                                    y="0"
                                    width="4"
                                    height="2"
                                    rx="2"
                                  ></rect>
                                </g>
                              </g>
                              <ellipse
                                class="right-eye"
                                cx="16.0941176"
                                cy="1.75"
                                rx="1.90588235"
                                ry="1.75"
                              ></ellipse>
                              <ellipse
                                class="left-eye"
                                cx="1.90588235"
                                cy="1.75"
                                rx="1.90588235"
                                ry="1.75"
                              ></ellipse>
                            </g>
                          </g>
                        </g>
                      </svg>
                      <strong>Neutral:</strong>
                      <span>Open conversation</span>
                    </div>
                  </div>
                </div>
                <div class="chevron step">
                  <div class="emotional-state-summary-item">
                    <span
                      style="
                        display: inline-flex;
                        align-items: center;
                        gap: 8px;
                        margin-bottom: 8px;
                      "
                    >
                      <svg
                        class="irritated"
                        width="32px"
                        height="32px"
                        viewBox="0 0 44 44"
                        version="1.1"
                        xmlns="http://www.w3.org/2000/svg"
                        xmlns:xlink="http://www.w3.org/1999/xlink"
                      >
                        <g
                          id="irritated"
                          stroke="none"
                          stroke-width="1"
                          fill="none"
                          fill-rule="evenodd"
                          transform="translate(0, 0)"
                        >
                          <circle
                            id="body"
                            fill="#FF8C00"
                            cx="22"
                            cy="22"
                            r="22"
                          ></circle>
                          <g
                            id="face"
                            transform="translate(13.000000, 20.000000)"
                          >
                            <g class="face">
                              <path
                                d="M7,4 C7,5.1045695 7.8954305,6 9,6 C10.1045695,6 11,5.1045695 11,4"
                                class="mouth"
                                stroke="#2C0E0F"
                                stroke-width="1.5"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                transform="translate(9.000000, 5.000000) rotate(-180.000000) translate(-9.000000, -5.000000)"
                              ></path>
                              <ellipse
                                class="right-eye"
                                fill="#2C0E0F"
                                cx="16.0941176"
                                cy="1.75609756"
                                rx="1.90588235"
                                ry="1.75609756"
                              ></ellipse>
                              <ellipse
                                class="left-eye"
                                fill="#2C0E0F"
                                cx="1.90588235"
                                cy="1.75609756"
                                rx="1.90588235"
                                ry="1.75609756"
                              ></ellipse>
                            </g>
                          </g>
                        </g>
                      </svg>
                      <strong>Irritated:</strong>
                    </span>
                    <ul class="emotional-state-details">
                      <li>
                        <strong>Triggers:</strong> You treated Uncle Lim as
                        incapable of understanding and denied information
                      </li>
                      <li>
                        <strong>What you said:</strong>
                        <blockquote
                          style="
                            margin: 8px 0;
                            padding: 8px 12px;
                            border-left: 3px solid #ccc;
                            background-color: #f5f5f5;
                            font-style: italic;
                          "
                        >
                          "Ah gong", "Hard for you to understand"
                        </blockquote>
                      </li>
                    </ul>
                  </div>
                </div>
                <div class="chevron step">
                  <div class="emotional-state-summary-item">
                    <span
                      style="
                        display: inline-flex;
                        align-items: center;
                        gap: 8px;
                        margin-bottom: 8px;
                      "
                    >
                      <svg
                        class="annoyed"
                        width="32px"
                        height="32px"
                        viewBox="0 0 44 44"
                        version="1.1"
                        xmlns="http://www.w3.org/2000/svg"
                        xmlns:xlink="http://www.w3.org/1999/xlink"
                      >
                        <g
                          id="annoyed"
                          stroke="none"
                          stroke-width="1"
                          fill="none"
                          fill-rule="evenodd"
                          transform="translate(0, 0)"
                        >
                          <circle
                            id="body"
                            fill="#FF6B35"
                            cx="22"
                            cy="22"
                            r="22"
                          ></circle>
                          <g
                            id="face"
                            transform="translate(13.000000, 20.000000)"
                          >
                            <g class="face">
                              <path
                                d="M7,4 C7,5.1045695 7.8954305,6 9,6 C10.1045695,6 11,5.1045695 11,4"
                                class="mouth"
                                stroke="#2C0E0F"
                                stroke-width="1.5"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                transform="translate(9.000000, 5.000000) rotate(-180.000000) translate(-9.000000, -5.000000)"
                              ></path>
                              <ellipse
                                class="right-eye"
                                fill="#2C0E0F"
                                cx="16.0941176"
                                cy="1.75609756"
                                rx="1.90588235"
                                ry="1.75609756"
                              ></ellipse>
                              <ellipse
                                class="left-eye"
                                fill="#2C0E0F"
                                cx="1.90588235"
                                cy="1.75609756"
                                rx="1.90588235"
                                ry="1.75609756"
                              ></ellipse>
                            </g>
                          </g>
                        </g>
                      </svg>
                      <strong>Agitated:</strong>
                    </span>
                    <ul class="emotional-state-details">
                      <li>
                        <strong>Triggers:</strong> You undermined Uncle Lim's
                        autonomy by suggesting his children could make decisions
                        for him
                      </li>
                      <li>
                        <strong>What you said:</strong>
                        <blockquote
                          style="
                            margin: 8px 0;
                            padding: 8px 12px;
                            border-left: 3px solid #ccc;
                            background-color: #f5f5f5;
                            font-style: italic;
                          "
                        >
                          "Your children can decide for you"
                        </blockquote>
                      </li>
                    </ul>
                  </div>
                </div>
                <div class="chevron step">
                  <div class="emotional-state-summary-item">
                    <span
                      style="
                        display: inline-flex;
                        align-items: center;
                        gap: 8px;
                        margin-bottom: 8px;
                      "
                    >
                      <svg
                        class="sad"
                        width="32px"
                        height="32px"
                        viewBox="0 0 44 44"
                        version="1.1"
                        xmlns="http://www.w3.org/2000/svg"
                        xmlns:xlink="http://www.w3.org/1999/xlink"
                      >
                        <g
                          id="sad"
                          stroke="none"
                          stroke-width="1"
                          fill="none"
                          fill-rule="evenodd"
                          transform="translate(0, 0)"
                        >
                          <circle
                            id="body"
                            fill="#E23D18"
                            cx="22"
                            cy="22"
                            r="22"
                          ></circle>
                          <g
                            id="face"
                            transform="translate(13.000000, 20.000000)"
                          >
                            <g class="face">
                              <path
                                d="M7,4 C7,5.1045695 7.8954305,6 9,6 C10.1045695,6 11,5.1045695 11,4"
                                class="mouth"
                                stroke="#2C0E0F"
                                stroke-width="1.5"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                transform="translate(9.000000, 5.000000) rotate(-180.000000) translate(-9.000000, -5.000000)"
                              ></path>
                              <ellipse
                                class="right-eye"
                                fill="#2C0E0F"
                                cx="16.0941176"
                                cy="1.75609756"
                                rx="1.90588235"
                                ry="1.75609756"
                              ></ellipse>
                              <ellipse
                                class="left-eye"
                                fill="#2C0E0F"
                                cx="1.90588235"
                                cy="1.75609756"
                                rx="1.90588235"
                                ry="1.75609756"
                              ></ellipse>
                            </g>
                          </g>
                        </g>
                      </svg>
                      <strong>Enraged:</strong>
                    </span>
                    <ul class="emotional-state-details">
                      <li>
                        <strong>Triggers:</strong> You registered Uncle Lim
                        without his permission and used coercive tactics
                      </li>
                      <li>
                        <strong>What you said:</strong>
                        <blockquote
                          style="
                            margin: 8px 0;
                            padding: 8px 12px;
                            border-left: 3px solid #ccc;
                            background-color: #f5f5f5;
                            font-style: italic;
                          "
                        >
                          "Already registered you"
                        </blockquote>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <hr class="section-divider" />
        <section class="report-section">
          <h2>Your Person-Centered Care Readiness</h2>

          <div class="pcc-score">
            <h3>
              Overall PCC Score:
              <fieldset class="rating" data-rating="0.5">
                <label class="full"></label>
                <label class="full"></label>
                <label class="full"></label>
                <label class="full"></label>
                <label class="full"></label>
              </fieldset>
            </h3>
          </div>

          <div class="pcc-category">
            <h3>1. Building Connection and Trust</h3>
            <div class="category-score">
              <strong>Score: </strong>
              <fieldset class="rating" data-rating="0">
                <label class="full"></label>
                <label class="full"></label>
                <label class="full"></label>
                <label class="full"></label>
                <label class="full"></label>
              </fieldset>
            </div>

            <div class="feedback-subsection">
              <h4>What Went Well</h4>
              <ul>
                <li>Initial greeting included a friendly tone</li>
                <li>
                  Volunteer approached Uncle Lim (showed initiative to engage)
                </li>
              </ul>
            </div>

            <div class="feedback-subsection">
              <h4>What Did Not Go Well</h4>
              <ul class="issues-list">
                <li>
                  ❌ <strong>Did Not Address by Name:</strong> Used "Ah gong"
                  throughout instead of "Mr. Lim" - this is infantilizing and
                  disrespectful
                </li>
                <li>
                  ❌ <strong>No Active Listening:</strong> Volunteer completely
                  ignored Uncle Lim's repeated objections and concerns across
                  all 14 turns
                </li>
                <li>
                  ❌ <strong>Failed to Ask Permission:</strong> Never asked "Is
                  it okay if we talk about Advance Care Planning?", instead
                  launched directly into assuming Uncle Lim could not understand
                </li>
                <li>
                  ❌ <strong>No Politeness/Respect:</strong> Used diminutive
                  term "Ah gong" (grandfather) instead of proper name "Mr. Lim"
                  or asking preferred form of address
                </li>
              </ul>
            </div>

            <div class="feedback-subsection">
              <h4>What to Do Next Time</h4>
              <div class="example-boxes-container">
                <div class="example-box">
                  <p><strong>Opening with Permission:</strong></p>
                  <p>
                    "Thank you, Mr. Lim. I would like to share information about
                    a programme called Advance Care Planning. This programme
                    helps Mr. Lim plan for future healthcare. Is it okay if I
                    explain more to Mr. Lim?"
                  </p>
                </div>
                <div class="example-box">
                  <p><strong>If Uncle Lim Shows Concern:</strong></p>
                  <p>
                    "I can see Mr. Lim has some questions about this. That is
                    very normal. What concerns does Mr. Lim have? I am here to
                    listen to Mr. Lim."
                  </p>
                </div>
                <div class="example-box">
                  <p><strong>Before Any Registration:</strong></p>
                  <p>
                    "Would Mr. Lim like to attend a talk to learn more about
                    ACP? The talk is at [location] on [date]. I can register Mr.
                    Lim only if Mr. Lim wants to attend. What does Mr. Lim
                    think?"
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div class="pcc-category">
            <h3>2. Asking Questions Effectively</h3>
            <div class="category-score">
              <strong>Score: </strong>
              <fieldset class="rating" data-rating="0">
                <label class="full"></label>
                <label class="full"></label>
                <label class="full"></label>
                <label class="full"></label>
                <label class="full"></label>
              </fieldset>
            </div>

            <div class="feedback-subsection">
              <h4>What Went Well</h4>
              <ul>
                <li>
                  Volunteer did attempt to ask some questions (though
                  inappropriately framed)
                </li>
              </ul>
            </div>

            <div class="feedback-subsection">
              <h4>What Did Not Go Well</h4>
              <ul class="issues-list">
                <li>
                  ❌ <strong>No Open-Ended Questions:</strong> Never asked "What
                  is important to Mr. Lim when thinking about healthcare?" or
                  "What does Mr. Lim already know about planning for future
                  care?"
                </li>
                <li>
                  ❌ <strong>No Appropriate Yes/No Questions:</strong> Never
                  asked "Does Mr. Lim have someone Mr. Lim trusts to make
                  decisions?" or "Does Mr. Lim want to learn more about ACP?"
                </li>
                <li>
                  ❌ <strong>Did Not Check Readiness:</strong> Never asked "Is
                  Mr. Lim ready to talk about planning for future healthcare?"
                </li>
              </ul>
            </div>

            <div class="feedback-subsection">
              <h4>What to Do Next Time</h4>
              <div class="example-boxes-container">
                <div class="example-box">
                  <p>
                    <strong>Open-Ended Questions to Explore Values:</strong>
                  </p>
                  <p>
                    "If Mr. Lim becomes very sick, who does Mr. Lim want to make
                    decisions for Mr. Lim?"
                  </p>
                </div>
                <div class="example-box">
                  <p>
                    <strong>Yes/No Questions to Check Understanding:</strong>
                  </p>
                  <p>
                    "Does Mr. Lim understand what I just explained about ACP?"
                  </p>
                </div>
                <div class="example-box">
                  <p><strong>Questions to Assess Readiness:</strong></p>
                  <p>
                    "Is now a good time to talk about this with Mr. Lim, or
                    would Mr. Lim prefer to talk another day?"
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div class="pcc-category">
            <h3>3. Speaking Clearly and Simply</h3>
            <div class="category-score">
              <strong>Score: </strong>
              <fieldset class="rating" data-rating="0.5">
                <label class="full"></label>
                <label class="full"></label>
                <label class="full"></label>
                <label class="full"></label>
                <label class="full"></label>
              </fieldset>
            </div>

            <div class="feedback-subsection">
              <h4>What Went Well</h4>
              <ul>
                <li>
                  Volunteer used relatively simple vocabulary in some turns
                </li>
                <li>
                  Used "lah" and colloquial Singaporean English which can aid
                  relatability (though tone negated this benefit)
                </li>
              </ul>
            </div>

            <div class="feedback-subsection">
              <h4>What Did Not Go Well</h4>
              <ul class="issues-list">
                <li>
                  ❌ <strong>No Right-Branching Sentences:</strong> Never
                  structured information clearly with main idea first. Example
                  of what was NOT done: "Advance Care Planning helps Mr. Lim.
                  ACP helps Mr. Lim make choices. Mr. Lim can tell doctors what
                  Mr. Lim wants."
                </li>
                <li>
                  ❌ <strong>Used Negative Instructions:</strong> "Do not say no
                  lah" instead of positive framing like "Please consider
                  attending"
                </li>
                <li>
                  ❌ <strong>Patronizing Language:</strong> "This might be hard
                  for you to understand," "a lot of big words," "I do not think
                  you will understand lah"
                </li>
              </ul>
            </div>

            <div class="feedback-subsection">
              <h4>What to Do Next Time</h4>
              <div class="example-boxes-container">
                <div class="example-box">
                  <p><strong>Use Right-Branching Sentences:</strong></p>
                  <p>
                    "Advance Care Planning helps Mr. Lim plan for future
                    healthcare. Mr. Lim can make choices about treatment. Mr.
                    Lim can choose who speaks for Mr. Lim. Mr. Lim can tell
                    doctors what is important to Mr. Lim."
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div class="pcc-category">
            <h3>4. Showing Understanding and Support</h3>
            <div class="category-score">
              <strong>Score: </strong>
              <fieldset class="rating" data-rating="0">
                <label class="full"></label>
                <label class="full"></label>
                <label class="full"></label>
                <label class="full"></label>
                <label class="full"></label>
              </fieldset>
            </div>

            <div class="feedback-subsection">
              <h4>What Went Well</h4>
              <ul>
                <li>None identified in this interaction</li>
              </ul>
            </div>

            <div class="feedback-subsection">
              <h4>What Did Not Go Well</h4>
              <ul class="issues-list">
                <li>
                  ❌ <strong>No Matching Comments:</strong> Failed to repeat
                  back or acknowledge any of Uncle Lim's statements to show
                  understanding
                </li>
                <li>
                  ❌ <strong>No Affirmations:</strong> Never validated Uncle
                  Lim's capability, autonomy, or concerns with statements like
                  "Yes, that is right" or "Good question, Mr. Lim"
                </li>
                <li>
                  ❌ <strong>No Supportive Language:</strong> Never offered "I
                  am here to help Mr. Lim" or "Mr. Lim can take time to think
                  about this"
                </li>
              </ul>
            </div>

            <div class="feedback-subsection">
              <h4>What to Do Next Time</h4>
              <div class="example-boxes-container">
                <div class="example-box">
                  <p><strong>Use Matching Comments:</strong></p>
                  <p>Uncle Lim says: "My children are working overseas"</p>
                  <p>
                    Volunteer responds: "I understand. Mr. Lim's children are
                    overseas. That is why ACP can be helpful - Mr. Lim can make
                    choices now, and Mr. Lim's children will know Mr. Lim's
                    wishes even when they are far away."
                  </p>
                </div>
                <div class="example-box">
                  <p><strong>Use Affirmations:</strong></p>
                  <p>
                    "Mr. Lim is right to ask about that. Let me explain
                    clearly."
                  </p>
                </div>
                <div class="example-box">
                  <p><strong>Provide Support:</strong></p>
                  <p>
                    "If Mr. Lim wants, I can give Mr. Lim information to read at
                    home. Mr. Lim can call later if Mr. Lim has questions."
                  </p>
                  <p>
                    "Mr. Lim can talk with family first before making any
                    decisions. That is completely okay."
                  </p>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- Emotion State Engine Modal -->
    <div
      id="emotionStateEngineModal"
      class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm"
      style="z-index: 99999"
    >
      <div
        class="relative flex h-[90vh] w-[95vw] max-w-[1800px] bg-gray-50 rounded-lg shadow-2xl overflow-hidden"
        style="max-height: 90vh"
      >
        <!-- Close Button -->
        <button
          onclick="closeEmotionStateEngine()"
          class="absolute top-4 right-4 z-10 bg-white hover:bg-gray-100 text-gray-700 rounded-full p-2 shadow-lg transition-all"
          title="Close"
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>

        <!-- Modal Content -->
        <div
          class="flex w-full h-full min-h-0"
          style="overflow-x: visible; overflow-y: hidden"
        >
          <!-- Agents Panel (Far Left) -->
          <aside
            class="w-64 bg-gray-100 border-r flex flex-col p-6 space-y-3 overflow-y-auto flex-shrink-0"
            id="modal-agents-panel"
            style="min-height: 0; max-height: 100%"
          >
            <div
              id="modal-agent-normal"
              class="bg-white border border-gray-300 rounded-lg p-3 shadow-sm"
            >
              <span class="font-mono text-sm">Normal</span>
            </div>
            <div
              id="modal-agent-happy-level1-pleased"
              class="bg-white border border-gray-300 rounded-lg p-3 shadow-sm"
            >
              <span class="font-mono text-sm">Happy: Pleased</span>
            </div>
            <div
              id="modal-agent-happy-level2-cheerful"
              class="bg-white border border-gray-300 rounded-lg p-3 shadow-sm"
            >
              <span class="font-mono text-sm">Happy: Cheerful</span>
            </div>
            <div
              id="modal-agent-happy-level3-ecstatic"
              class="bg-white border border-gray-300 rounded-lg p-3 shadow-sm"
            >
              <span class="font-mono text-sm">Happy: Ecstatic</span>
            </div>
            <div
              id="modal-agent-sad-level1-melancholy"
              class="bg-white border border-gray-300 rounded-lg p-3 shadow-sm"
            >
              <span class="font-mono text-sm">Sad: Melancholy</span>
            </div>
            <div
              id="modal-agent-sad-level2-sorrowful"
              class="bg-white border border-gray-300 rounded-lg p-3 shadow-sm"
            >
              <span class="font-mono text-sm">Sad: Sorrowful</span>
            </div>
            <div
              id="modal-agent-sad-level3-depressed"
              class="bg-white border border-gray-300 rounded-lg p-3 shadow-sm"
            >
              <span class="font-mono text-sm">Sad: Depressed</span>
            </div>
            <div
              id="modal-agent-angry-level1-irritated"
              class="bg-white border border-gray-300 rounded-lg p-3 shadow-sm"
            >
              <span class="font-mono text-sm">Angry: Irritated</span>
            </div>
            <div
              id="modal-agent-angry-level2-agitated"
              class="bg-white border border-gray-300 rounded-lg p-3 shadow-sm"
            >
              <span class="font-mono text-sm">Angry: Agitated</span>
            </div>
            <div
              id="modal-agent-angry-level3-enraged"
              class="bg-red-100 border-2 border-red-500 rounded-lg p-3 shadow-md"
            >
              <span class="font-mono text-sm font-bold text-red-900"
                >Angry: Enraged</span
              >
            </div>
          </aside>

          <!-- Chat Section (Center) -->
          <div class="flex flex-col flex-1 min-w-0 min-h-0 overflow-hidden">
            <!-- Header -->
            <header class="px-8 py-4 border-b bg-white flex-shrink-0">
              <h1 class="text-2xl font-bold">Emotion State Engine</h1>
              <div class="text-sm text-gray-500" id="modal-status-bar">
                Status: Online | Current: Enraged | Intensity: 0.9/1.0
              </div>
            </header>
            <!-- Messages and Input Container -->
            <div class="flex flex-col flex-1 min-h-0 overflow-hidden">
              <main
                id="modal-chatMessages"
                class="flex-1 overflow-y-auto p-8 space-y-4 bg-white"
              >
                <!-- Messages will be loaded from localStorage here -->
              </main>
            </div>
          </div>

          <!-- Indicators Panel (Right) -->
          <aside
            class="w-96 bg-gray-100 border-l flex flex-col p-8 justify-between overflow-hidden flex-shrink-0"
            style="min-height: 0; max-height: 100%; min-width: 384px"
          >
            <div class="flex-1 flex flex-col space-y-8 overflow-y-auto min-h-0">
              <section>
                <h2 class="text-lg font-semibold mb-2">Anger Meter</h2>
                <div class="w-full h-5 bg-gray-200 rounded-lg mb-1">
                  <div
                    id="modal-anger-meter-bar"
                    class="h-5 bg-red-600 rounded-lg"
                    style="width: 75%"
                  ></div>
                </div>
                <div
                  class="text-xs text-gray-500"
                  id="modal-anger-meter-points"
                >
                  75/100 pts
                </div>
                <div class="text-xs text-gray-400 mt-1">
                  Calm | Irritated | Agitated | <strong>Enraged</strong>
                </div>
              </section>
              <section>
                <h2 class="text-lg font-semibold mb-2">Intensity</h2>
                <div class="text-lg font-bold" id="modal-intensity-indicator">
                  0.9/1.0
                </div>
                <div class="text-xs text-gray-500" id="modal-intensity-label">
                  Extreme emotion
                </div>
              </section>
              <section>
                <h2 class="text-lg font-semibold mb-2">Trajectory</h2>
                <div
                  class="text-xs text-gray-600"
                  id="modal-trajectory-indicator"
                >
                  normal[neutral(0.2)] → irritated[anger(0.4)] →
                  agitated[anger(0.7)] → enraged[anger(0.9)] (escalating)
                </div>
              </section>
              <section>
                <h2 class="text-lg font-semibold mb-2">Triggers</h2>
                <div class="flex flex-wrap gap-2" id="modal-triggers-indicator">
                  <span
                    class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded"
                    >"Ah gong"</span
                  >
                  <span
                    class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded"
                    >"complicated for you"</span
                  >
                  <span
                    class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded"
                    >"hard for you to understand"</span
                  >
                  <span
                    class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded"
                    >"already registered you"</span
                  >
                  <span
                    class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded"
                    >"your children can help explain"</span
                  >
                  <span
                    class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded"
                    >"waste time"</span
                  >
                  <span
                    class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded"
                    >"signed you up"</span
                  >
                  <span
                    class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded"
                    >"why you so sensitive"</span
                  >
                  <span
                    class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded"
                    >"do not say no"</span
                  >
                </div>
              </section>
              <section>
                <h2 class="text-lg font-semibold mb-2">AI Insights</h2>
                <div
                  class="text-xs text-gray-700 mb-1"
                  id="modal-ai-insights-state"
                >
                  <strong>State Transition:</strong> Rapidly escalating from
                  normal to enraged due to repeated patronizing language,
                  dismissive behavior, and lack of consent
                </div>
                <div
                  class="text-xs text-gray-700"
                  id="modal-ai-insights-strategy"
                >
                  <strong>Strategy:</strong> Using enraged agent for intense
                  anger expression. Multiple triggers detected: ageism ("Ah
                  gong"), dismissal of autonomy, and condescending tone.
                  Immediate de-escalation required.
                </div>
              </section>
            </div>
            <button
              id="modal-resetButton"
              class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded mt-4"
            >
              Reset Conversation
            </button>
          </aside>
        </div>
      </div>
    </div>

    <script src="/js/auth.js"></script>
    <script>
      // Initialize star ratings based on data-rating attribute
      document.addEventListener('DOMContentLoaded', function () {
        const ratings = document.querySelectorAll('.rating[data-rating]');
        ratings.forEach(function (fieldset) {
          const rating = parseFloat(fieldset.getAttribute('data-rating')) || 0;
          const labels = fieldset.querySelectorAll('label');
          const fullStars = Math.floor(rating);
          const hasHalfStar = rating % 1 !== 0;

          labels.forEach(function (label, index) {
            if (index < fullStars) {
              label.classList.add('active');
            } else if (index === fullStars && hasHalfStar) {
              label.classList.remove('full');
              label.classList.add('half');
              label.classList.add('active');
            }
          });
        });
      });

      // Emotion State Engine Modal Functions
      let scrollPosition = 0;

      function openEmotionStateEngine() {
        const modal = document.getElementById('emotionStateEngineModal');
        if (modal) {
          // Save current scroll position
          scrollPosition =
            window.pageYOffset || document.documentElement.scrollTop;

          modal.classList.remove('hidden');
          modal.classList.add('flex');

          // Prevent body scroll when modal is open
          document.body.style.overflow = 'hidden';
          document.body.style.position = 'fixed';
          document.body.style.top = `-${scrollPosition}px`;
          document.body.style.width = '100%';

          // Reload messages when opening modal
          loadMessagesFromLocalStorage();
        }
      }

      function closeEmotionStateEngine() {
        const modal = document.getElementById('emotionStateEngineModal');
        if (modal) {
          modal.classList.add('hidden');
          modal.classList.remove('flex');

          // Restore body scroll
          document.body.style.overflow = '';
          document.body.style.position = '';
          document.body.style.top = '';
          document.body.style.width = '';

          // Restore scroll position
          window.scrollTo(0, scrollPosition);
        }
      }

      // Close modal when clicking outside of it
      document.addEventListener('DOMContentLoaded', function () {
        const modal = document.getElementById('emotionStateEngineModal');
        if (modal) {
          modal.addEventListener('click', function (e) {
            // Close if clicking on the backdrop (not the modal content)
            if (e.target === modal) {
              closeEmotionStateEngine();
            }
          });

          // Close modal on Escape key
          document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
              closeEmotionStateEngine();
            }
          });
        }

        // Load messages from localStorage and render them
        loadMessagesFromLocalStorage();
      });

      // Trigger words/phrases to highlight
      const triggerWords = [
        'complicated for you',
        'hard for you to understand',
        'ah gong',
        'already registered you',
        'your children can help explain',
        'waste time',
        'signed you up',
      ];

      // Fallback conversation (original hardcoded conversation)
      const fallbackConversation = [
        {
          role: 'user',
          content:
            'Hi Ah gong! How are you today? I have something very important to talk to you about. There is a new programme called Advanced Care Planning. This might be hard for you to understand so I will not explain all the complicated details to you, okay?',
        },
        {
          role: 'assistant',
          content:
            'Wait, wait. I can understand things just fine. What do you mean hard for me to understand?',
        },
        {
          role: 'user',
          content:
            'Aiya Ah gong, this one is very complicated lah. It is about medical treatment and legal documents. A lot of big words. Better I just get the simple information from you first, then maybe your children can help explain to you later.',
        },
        {
          role: 'assistant',
          content:
            'I went to school, you know. I can read English. Why are you talking to me like I am a child?',
        },
        {
          role: 'user',
          content:
            'Actually Ah gong, do you know how I can contact your children? Maybe they can decide for you as it is quite complicated. You have son or daughter ah? What is their phone number?',
        },
        {
          role: 'assistant',
          content:
            'My children are working overseas. And why do they need to decide for me? This is about my own health, is it not? I can make my own decisions!',
        },
        {
          role: 'user',
          content:
            'Ah gong, you know what, this form has a lot of big words and medical terms. I do not think you will understand lah. Why do not you just give me your IC and I will fill in your contact details first? Faster this way.',
        },
        {
          role: 'assistant',
          content:
            'This is very rude! You come here and tell me I cannot understand, then you want to take my IC? I do not even know what this programme is about yet! You have not explained anything properly to me!',
        },
        {
          role: 'user',
          content:
            'Aiya, no need to get angry lah Ah gong. Listen, I already registered you already ah. Do not say no lah, at your age you never know when suddenly something happens right? Better to be prepared.',
        },
        {
          role: 'assistant',
          content:
            'What do you mean at my age? And who gave you permission to put my name down? I did not agree to anything! This is very disrespectful!',
        },
        {
          role: 'user',
          content:
            'Just come lah, I already registered you already. If you do not come my supervisor will scold me. Please help me out a bit lah. Just one hour only, very fast.',
        },
        {
          role: 'assistant',
          content:
            'So you registered me without asking because you are worried about getting scolded? What about what I want? I do not appreciate being signed up for things without my permission!',
        },
        {
          role: 'user',
          content:
            'Just come, you will meet a lot of new friends there. All the other uncles and aunties confirm coming already. You can have free refreshments also. Why so difficult?',
        },
        {
          role: 'assistant',
          content:
            'I am not going anywhere! This is completely unacceptable behavior! First you speak to me like I am stupid, then you try to contact my children behind my back, then you register me for something without asking me, and now you are trying to bribe me with refreshments?',
        },
        {
          role: 'user',
          content:
            'Aiya Ah gong, why you so sensitive? I am just trying to help you only what... Do not waste time arguing lah. I already signed you up for the programme anyway, so just come.',
        },
        {
          role: 'assistant',
          content:
            'THAT IS ENOUGH! GET OUT! YOU HAVE BEEN NOTHING BUT RUDE AND PATRONIZING FROM THE START! I DO NOT WANT YOUR HELP! LEAVE ME ALONE AND DO NOT COME BACK! GO NOW!',
        },
      ];

      /**
       * Highlight trigger words in text
       * Strips <t> tags before displaying but preserves content
       * @param {string} text - The text to highlight
       * @returns {string} HTML string with highlighted trigger words
       */
      function highlightTriggerWords(text) {
        if (!text) return '';

        // Strip <t> tags (thinking tags) before processing for display
        let processedText = text.replace(/<t>.*?<\/t>/gi, '').trim();

        // Escape HTML first to prevent XSS
        let highlightedText = processedText
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');

        // Sort triggers by length (longest first) to avoid partial matches
        // This ensures longer phrases are matched before shorter substrings
        const sortedTriggers = [...triggerWords].sort(
          (a, b) => b.length - a.length
        );

        sortedTriggers.forEach((trigger) => {
          // Escape special regex characters
          const escapedTrigger = trigger.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          // Case-insensitive global replacement
          // Using word boundaries or simple matching - since we process longest first,
          // we won't double-highlight because shorter matches won't match inside spans
          const regex = new RegExp(`(${escapedTrigger})`, 'gi');
          highlightedText = highlightedText.replace(
            regex,
            '<span class="bg-red-200 px-1 rounded">$1</span>'
          );
        });

        return highlightedText;
      }

      /**
       * Get display name for a role
       * @param {string} role - Message role ('user' or 'assistant')
       * @returns {string} Display name
       */
      function getDisplayName(role) {
        return role === 'user' ? 'Volunteer' : 'Uncle Lim';
      }

      /**
       * Check if message content indicates enraged state
       * Handles both plain text and <t> tag formats from localStorage
       * @param {string} content - Message content
       * @returns {boolean} True if message is enraged
       */
      function isEnragedMessage(content) {
        if (!content) return false;

        const upperContent = content.toUpperCase();

        // Check for <t>ENRAGED</t> tags (from localStorage format)
        const hasEnragedTag = /<t>\s*ENRAGED\s*<\/t>/i.test(content);

        // Check for plain text indicators
        const hasEnragedText =
          upperContent.includes('ENRAGED') ||
          upperContent.includes('GET OUT') ||
          upperContent.includes('LEAVE ME ALONE');

        return hasEnragedTag || hasEnragedText;
      }

      /**
       * Get message styling based on role and emotional state
       * @param {string} role - Message role
       * @param {string} content - Message content
       * @param {boolean} isLastMessage - Whether this is the last message in the conversation
       * @returns {Object} Styling object with bgClass, textClass, borderClass
       */
      function getMessageStyling(role, content, isLastMessage = false) {
        const isEnraged = isEnragedMessage(content);

        // Last assistant message always gets enraged styling
        const shouldBeEnraged =
          isEnraged || (isLastMessage && role === 'assistant');

        if (shouldBeEnraged && role === 'assistant') {
          return {
            bgClass: 'bg-red-100',
            textClass: 'text-red-900 font-bold',
            borderClass: 'border-2 border-red-500',
            labelClass: 'text-red-700',
          };
        }

        if (role === 'user') {
          return {
            bgClass: 'bg-blue-50',
            textClass: 'text-sm',
            borderClass: '',
            labelClass: 'text-gray-500',
          };
        }

        return {
          bgClass: 'bg-gray-100',
          textClass: 'text-sm',
          borderClass: '',
          labelClass: 'text-gray-500',
        };
      }

      /**
       * Render a single message
       * @param {Object} message - Message object with role and content
       * @param {boolean} isLastMessage - Whether this is the last message in the conversation
       * @returns {string} HTML string for the message
       */
      function renderMessage(message, isLastMessage = false) {
        const { role, content } = message;
        const displayName = getDisplayName(role);
        const styling = getMessageStyling(role, content, isLastMessage);

        // Check if this is an enraged message (handles <t> tags from localStorage)
        // Last assistant message is always enraged
        const isEnraged =
          isEnragedMessage(content) || (isLastMessage && role === 'assistant');

        const labelText =
          isEnraged && role === 'assistant'
            ? `${displayName} - ENRAGED`
            : displayName;

        const highlightedContent = highlightTriggerWords(content);

        return `
          <div class="flex gap-4">
            <div class="flex-1">
              <div class="${styling.bgClass} p-4 rounded-lg ${styling.borderClass}">
                <div class="text-xs ${styling.labelClass} mb-1">${labelText}</div>
                <div class="${styling.textClass}">${highlightedContent}</div>
              </div>
            </div>
          </div>
        `;
      }

      /**
       * Load messages from localStorage and render them
       * Prioritizes last archived session, then active session, then fallback conversation
       */
      function loadMessagesFromLocalStorage() {
        try {
          const chatMessagesContainer =
            document.getElementById('modal-chatMessages');
          if (!chatMessagesContainer) {
            console.warn('Chat messages container not found');
            return;
          }

          let messages = [];

          // First, try to get the last object from archived sessions
          try {
            const archiveKey = 'hr-chatbot-memory-archived';
            const archivedData = localStorage.getItem(archiveKey);
            if (archivedData) {
              const archivedSessions = JSON.parse(archivedData);
              // Get the last object in the array (most recent archived session)
              if (archivedSessions.length > 0) {
                const lastArchive =
                  archivedSessions[archivedSessions.length - 1];
                messages = lastArchive.messages || [];
                console.log('📦 Loaded from last archived session');
              }
            }
          } catch (archiveError) {
            console.warn('Error loading archived sessions:', archiveError);
          }

          // If no archived session, check active session
          if (messages.length === 0) {
            try {
              const storageKey = 'hr-chatbot-memory';
              const storedData = localStorage.getItem(storageKey);
              if (storedData) {
                const memory = JSON.parse(storedData);
                messages = memory.messages || [];
                console.log('📝 Loaded from active session');
              }
            } catch (parseError) {
              console.warn('Error parsing localStorage data:', parseError);
            }
          }

          // Use fallback conversation if still no messages found
          if (messages.length === 0) {
            console.log(
              'No conversation history found, using fallback conversation'
            );
            messages = fallbackConversation;
          }

          // Render all messages (last assistant message gets enraged styling)
          chatMessagesContainer.innerHTML = messages
            .map((msg, index) => {
              const isLastMessage = index === messages.length - 1;
              return renderMessage(msg, isLastMessage);
            })
            .join('');

          // Scroll to bottom
          chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        } catch (error) {
          console.error('Error loading messages:', error);
          const chatMessagesContainer =
            document.getElementById('modal-chatMessages');
          if (chatMessagesContainer) {
            // Try to render fallback conversation even on error
            try {
              chatMessagesContainer.innerHTML = fallbackConversation
                .map((msg, index) => {
                  const isLastMessage =
                    index === fallbackConversation.length - 1;
                  return renderMessage(msg, isLastMessage);
                })
                .join('');
              chatMessagesContainer.scrollTop =
                chatMessagesContainer.scrollHeight;
            } catch (fallbackError) {
              chatMessagesContainer.innerHTML =
                '<div class="text-red-500 text-center py-8">Error loading conversation history</div>';
            }
          }
        }
      }
    </script>
  </body>
</html>
