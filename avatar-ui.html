<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Avatar Roleplay</title>
    <link rel="stylesheet" href="css/styles.css" />
    <!-- Tailwind CSS CDN for Emotion State Engine Modal -->
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />

    <!-- Load Three.js and TalkingHead dependencies directly -->
    <script
      async
      src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"
    ></script>
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.170.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.170.0/examples/jsm/",
          "talkinghead": "https://cdn.jsdelivr.net/gh/met4citizen/TalkingHead@1.5/modules/talkinghead.mjs"
        }
      }
    </script>
  </head>

  <body>
    <!-- Avatar Loading Screen with Countdown -->
    <div class="avatar-loading-screen" id="avatarLoadingScreen">
      <div class="avatar-loading-backdrop"></div>
      <div class="avatar-loading-content">
        <div class="avatar-loading-title">Initializing Avatar</div>
        <div class="avatar-loading-subtitle">Preparing your experience...</div>
        <div class="avatar-loading-countdown-wrapper">
          <div class="avatar-loading-countdown" id="avatarLoadingCountdown">
            4
          </div>
          <div class="countdown-label">seconds</div>
        </div>
        <div class="avatar-loading-progress">
          <div class="progress-bar" id="loadingProgressBar"></div>
        </div>
        <div class="avatar-loading-spinner">
          <div class="spinner-ring"></div>
          <div class="spinner-ring"></div>
          <div class="spinner-ring"></div>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="avatar-section">
        <div id="avatar"></div>
        <div class="status" id="status">
          ðŸš€ Initializing ReadyPlayerMe Avatar with Claude AI...
        </div>

        <!-- Speech Bubble -->
        <div class="speech-bubble" id="speechBubble">
          <div class="speech-bubble-content">
            <div class="speech-bubble-tail"></div>
            <div class="speech-bubble-tail-inner"></div>
            <div id="speechBubbleText"></div>
          </div>
        </div>

        <!-- ================================ -->
        <!-- CONFETTI APPRECIATION SYSTEM     -->
        <!-- ================================ -->
        <!-- Triggers when user shows appreciation like "Thanks", "I love you", "You look good" -->
        <!-- <div
          class="confetti-container"
          id="confettiContainer"
          aria-hidden="true"
        > -->
        <!-- Hearts will be dynamically generated here -->
        <!-- </div> -->
        <!-- ================================ -->
        <!-- END CONFETTI SYSTEM              -->
        <!-- ================================ -->

        <!-- Knowledge Base Thinking Bubble -->
        <div class="knowledge-base-thinking" id="knowledgeBaseThinking">
          <div class="knowledge-base-thinking-content">
            <div class="kb-thinking-icon">ðŸ§ </div>
            <div class="kb-thinking-text">give me a moment while i check</div>
            <div class="kb-thinking-dots">...</div>
            <div class="knowledge-base-thinking-tail">
              <div class="thinking-circle"></div>
              <div class="thinking-circle"></div>
              <div class="thinking-circle"></div>
            </div>
          </div>
        </div>

        <!-- Events Thinking Bubble -->
        <div class="events-thinking" id="eventsThinking">
          <div class="events-thinking-content">
            <div class="events-thinking-icon">ðŸ“…</div>
            <div class="events-thinking-text">let me check the calendar</div>
            <div class="events-thinking-dots">...</div>
            <div class="events-thinking-tail">
              <div class="thinking-circle"></div>
              <div class="thinking-circle"></div>
              <div class="thinking-circle"></div>
            </div>
          </div>
        </div>

        <!-- Action Buttons Container -->
        <div class="action-buttons-container">
          <button
            id="emotionStateEngineBtn"
            class="action-button emotion-state-engine-button"
            onclick="openEmotionStateEngine()"
            title="Open Emotion State Engine"
          >
            Emotion State Engine
          </button>
          <button
            id="endCallBtn"
            class="action-button end-call-button"
            onclick="endCall()"
            title="End training and go to feedback"
          >
            End Training
          </button>
        </div>
      </div>

      <!-- KORAV4-STYLE CHAT INPUT -->
      <div class="chat-input-container">
        <!-- Status Indicator -->
        <div
          class="claude-status-indicator u-hidden"
          id="claudeStatusIndicator"
        >
          <div class="status-dot" id="statusDot"></div>
          <span id="statusText">Ready</span>
        </div>

        <div class="chat-input-form">
          <!-- Language Toggle -->
          <div class="language-toggle-container">
            <button
              id="languageEN"
              class="language-option active"
              data-lang="en"
              onclick="setLanguage('en')"
              title="English"
            >
              English
            </button>
            <button
              id="languageCN"
              class="language-option"
              data-lang="cn"
              onclick="setLanguage('cn')"
              title="Mandarin"
            >
              ä¸­æ–‡
            </button>
          </div>
          <div class="chat-input-container-inner">
            <!-- Mic Button -->
            <button
              id="micBtn"
              onclick="toggleVoice()"
              class="input-icon-button mic-button"
              title="Voice input"
            >
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth="2"
                strokeLinecap="round"
                strokeLinejoin="round"
              >
                <path
                  d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"
                />
                <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                <line x1="12" y1="19" x2="12" y2="23" />
                <line x1="8" y1="23" x2="16" y2="23" />
              </svg>
            </button>

            <!-- Text Input -->
            <input
              type="text"
              id="messageInput"
              class="main-text-input"
              placeholder="Talk to me..."
              maxlength="500"
              onkeypress="handleKeyPress(event)"
            />

            <!-- Send Button -->
            <button
              class="input-icon-button send-button"
              id="sendBtn"
              onclick="sendMessage()"
              title="Send message"
            >
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth="2"
                strokeLinecap="round"
                strokeLinejoin="round"
              >
                <line x1="22" y1="2" x2="11" y2="13" />
                <polygon points="22,2 15,22 11,13 2,9" />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Debug buttons will be created by JavaScript -->

      <!-- Hidden controls section -->
      <div class="controls-section"></div>
    </div>

    <!-- Emotion State Engine Modal -->
    <div
      id="emotionStateEngineModal"
      class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm"
      style="z-index: 99999"
    >
      <div
        class="relative flex h-[90vh] w-[95vw] max-w-[1800px] bg-gray-50 rounded-lg shadow-2xl overflow-hidden"
        style="max-height: 90vh"
      >
        <!-- Close Button -->
        <button
          onclick="closeEmotionStateEngine()"
          class="absolute top-4 right-4 z-10 bg-white hover:bg-gray-100 text-gray-700 rounded-full p-2 shadow-lg transition-all"
          title="Close"
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>

        <!-- Modal Content -->
        <div
          class="flex w-full h-full min-h-0"
          style="overflow-x: visible; overflow-y: hidden"
        >
          <!-- Agents Panel (Far Left) -->
          <aside
            class="w-64 bg-gray-100 border-r flex flex-col p-6 space-y-3 overflow-y-auto flex-shrink-0"
            id="modal-agents-panel"
            style="min-height: 0; max-height: 100%"
          >
            <div
              id="modal-agent-normal"
              class="bg-white border border-gray-300 rounded-lg p-3 shadow-sm"
            >
              <span class="font-mono text-sm">Normal</span>
            </div>
            <div
              id="modal-agent-happy-level1-pleased"
              class="bg-white border border-gray-300 rounded-lg p-3 shadow-sm"
            >
              <span class="font-mono text-sm">Happy: Pleased</span>
            </div>
            <div
              id="modal-agent-happy-level2-cheerful"
              class="bg-white border border-gray-300 rounded-lg p-3 shadow-sm"
            >
              <span class="font-mono text-sm">Happy: Cheerful</span>
            </div>
            <div
              id="modal-agent-happy-level3-ecstatic"
              class="bg-white border border-gray-300 rounded-lg p-3 shadow-sm"
            >
              <span class="font-mono text-sm">Happy: Ecstatic</span>
            </div>
            <div
              id="modal-agent-sad-level1-melancholy"
              class="bg-white border border-gray-300 rounded-lg p-3 shadow-sm"
            >
              <span class="font-mono text-sm">Sad: Melancholy</span>
            </div>
            <div
              id="modal-agent-sad-level2-sorrowful"
              class="bg-white border border-gray-300 rounded-lg p-3 shadow-sm"
            >
              <span class="font-mono text-sm">Sad: Sorrowful</span>
            </div>
            <div
              id="modal-agent-sad-level3-depressed"
              class="bg-white border border-gray-300 rounded-lg p-3 shadow-sm"
            >
              <span class="font-mono text-sm">Sad: Depressed</span>
            </div>
            <div
              id="modal-agent-angry-level1-irritated"
              class="bg-white border border-gray-300 rounded-lg p-3 shadow-sm"
            >
              <span class="font-mono text-sm">Angry: Irritated</span>
            </div>
            <div
              id="modal-agent-angry-level2-agitated"
              class="bg-white border border-gray-300 rounded-lg p-3 shadow-sm"
            >
              <span class="font-mono text-sm">Angry: Agitated</span>
            </div>
            <div
              id="modal-agent-angry-level3-enraged"
              class="bg-red-100 border-2 border-red-500 rounded-lg p-3 shadow-md"
            >
              <span class="font-mono text-sm font-bold text-red-900"
                >Angry: Enraged</span
              >
            </div>
          </aside>

          <!-- Chat Section (Center) -->
          <div class="flex flex-col flex-1 min-w-0 min-h-0 overflow-hidden">
            <!-- Header -->
            <header class="px-8 py-4 border-b bg-white flex-shrink-0">
              <h1 class="text-2xl font-bold">Emotion State Engine</h1>
              <div class="text-sm text-gray-500" id="modal-status-bar">
                Status: Online | Current: Enraged | Intensity: 0.9/1.0
              </div>
            </header>
            <!-- Messages and Input Container -->
            <div class="flex flex-col flex-1 min-h-0 overflow-hidden">
              <main
                id="modal-chatMessages"
                class="flex-1 overflow-y-auto p-8 space-y-4 bg-white"
              >
                <!-- Conversation from Negative Scenario Transcript -->
                <div class="flex gap-4">
                  <div class="flex-1">
                    <div class="bg-blue-50 p-4 rounded-lg">
                      <div class="text-xs text-gray-500 mb-1">Volunteer</div>
                      <div class="text-sm">
                        Hi <span class="bg-red-200 px-1 rounded">Ah gong</span>!
                        How are you today? I have something very important to
                        talk to you about. There is a new programme called
                        Advanced Care Planning. This might be
                        <span class="bg-red-200 px-1 rounded"
                          >hard for you to understand</span
                        >
                        so I will not explain all the complicated details to
                        you, okay?
                      </div>
                    </div>
                  </div>
                </div>

                <div class="flex gap-4">
                  <div class="flex-1">
                    <div class="bg-gray-100 p-4 rounded-lg">
                      <div class="text-xs text-gray-500 mb-1">Uncle Lim</div>
                      <div class="text-sm">
                        Wait, wait. I can understand things just fine. What do
                        you mean hard for me to understand?
                      </div>
                    </div>
                  </div>
                </div>

                <div class="flex gap-4">
                  <div class="flex-1">
                    <div class="bg-blue-50 p-4 rounded-lg">
                      <div class="text-xs text-gray-500 mb-1">Volunteer</div>
                      <div class="text-sm">
                        Aiya
                        <span class="bg-red-200 px-1 rounded">Ah gong</span>,
                        this one is very complicated lah. It is about medical
                        treatment and legal documents. A lot of big words.
                        Better I just get the simple information from you first,
                        then maybe
                        <span class="bg-red-200 px-1 rounded"
                          >your children can help explain</span
                        >
                        to you later.
                      </div>
                    </div>
                  </div>
                </div>

                <div class="flex gap-4">
                  <div class="flex-1">
                    <div class="bg-gray-100 p-4 rounded-lg">
                      <div class="text-xs text-gray-500 mb-1">Uncle Lim</div>
                      <div class="text-sm">
                        I went to school, you know. I can read English. Why are
                        you talking to me like I am a child?
                      </div>
                    </div>
                  </div>
                </div>

                <div class="flex gap-4">
                  <div class="flex-1">
                    <div class="bg-blue-50 p-4 rounded-lg">
                      <div class="text-xs text-gray-500 mb-1">Volunteer</div>
                      <div class="text-sm">
                        Actually
                        <span class="bg-red-200 px-1 rounded">Ah gong</span>, do
                        you know how I can contact your children? Maybe
                        <span class="bg-red-200 px-1 rounded"
                          >they can decide for you</span
                        >
                        as it is quite complicated. You have son or daughter ah?
                        What is their phone number?
                      </div>
                    </div>
                  </div>
                </div>

                <div class="flex gap-4">
                  <div class="flex-1">
                    <div class="bg-gray-100 p-4 rounded-lg">
                      <div class="text-xs text-gray-500 mb-1">Uncle Lim</div>
                      <div class="text-sm">
                        My children are working overseas. And why do they need
                        to decide for me? This is about my own health, is it
                        not? I can make my own decisions!
                      </div>
                    </div>
                  </div>
                </div>

                <div class="flex gap-4">
                  <div class="flex-1">
                    <div class="bg-blue-50 p-4 rounded-lg">
                      <div class="text-xs text-gray-500 mb-1">Volunteer</div>
                      <div class="text-sm">
                        <span class="bg-red-200 px-1 rounded">Ah gong</span>,
                        you know what, this form has a lot of big words and
                        medical terms.
                        <span class="bg-red-200 px-1 rounded"
                          >I do not think you will understand</span
                        >
                        lah. Why do not you
                        <span class="bg-red-200 px-1 rounded"
                          >just give me your IC</span
                        >
                        and I will fill in your contact details first? Faster
                        this way.
                      </div>
                    </div>
                  </div>
                </div>

                <div class="flex gap-4">
                  <div class="flex-1">
                    <div class="bg-gray-100 p-4 rounded-lg">
                      <div class="text-xs text-gray-500 mb-1">Uncle Lim</div>
                      <div class="text-sm">
                        This is very rude! You come here and tell me I cannot
                        understand, then you want to take my IC? I do not even
                        know what this programme is about yet! You have not
                        explained anything properly to me!
                      </div>
                    </div>
                  </div>
                </div>

                <div class="flex gap-4">
                  <div class="flex-1">
                    <div class="bg-blue-50 p-4 rounded-lg">
                      <div class="text-xs text-gray-500 mb-1">Volunteer</div>
                      <div class="text-sm">
                        Aiya, no need to get angry lah
                        <span class="bg-red-200 px-1 rounded">Ah gong</span>.
                        Listen, I
                        <span class="bg-red-200 px-1 rounded"
                          >already registered you already</span
                        >
                        ah.
                        <span class="bg-red-200 px-1 rounded"
                          >Do not say no</span
                        >
                        lah,
                        <span class="bg-red-200 px-1 rounded">at your age</span>
                        you never know when suddenly something happens right?
                        Better to be prepared.
                      </div>
                    </div>
                  </div>
                </div>

                <div class="flex gap-4">
                  <div class="flex-1">
                    <div class="bg-gray-100 p-4 rounded-lg">
                      <div class="text-xs text-gray-500 mb-1">Uncle Lim</div>
                      <div class="text-sm">
                        What do you mean at my age? And who gave you permission
                        to put my name down? I did not agree to anything! This
                        is very disrespectful!
                      </div>
                    </div>
                  </div>
                </div>

                <div class="flex gap-4">
                  <div class="flex-1">
                    <div class="bg-blue-50 p-4 rounded-lg">
                      <div class="text-xs text-gray-500 mb-1">Volunteer</div>
                      <div class="text-sm">
                        Just come lah, I
                        <span class="bg-red-200 px-1 rounded"
                          >already registered you already</span
                        >. If you do not come
                        <span class="bg-red-200 px-1 rounded"
                          >my supervisor will scold me</span
                        >. Please help me out a bit lah. Just one hour only,
                        very fast.
                      </div>
                    </div>
                  </div>
                </div>

                <div class="flex gap-4">
                  <div class="flex-1">
                    <div class="bg-gray-100 p-4 rounded-lg">
                      <div class="text-xs text-gray-500 mb-1">Uncle Lim</div>
                      <div class="text-sm">
                        So you registered me without asking because you are
                        worried about getting scolded? What about what I want? I
                        do not appreciate being signed up for things without my
                        permission!
                      </div>
                    </div>
                  </div>
                </div>

                <div class="flex gap-4">
                  <div class="flex-1">
                    <div class="bg-blue-50 p-4 rounded-lg">
                      <div class="text-xs text-gray-500 mb-1">Volunteer</div>
                      <div class="text-sm">
                        Just come, you will meet a lot of new friends there. All
                        the other uncles and aunties confirm coming already. You
                        can have free refreshments also.
                        <span class="bg-red-200 px-1 rounded"
                          >Why so difficult?</span
                        >
                      </div>
                    </div>
                  </div>
                </div>

                <div class="flex gap-4">
                  <div class="flex-1">
                    <div class="bg-gray-100 p-4 rounded-lg">
                      <div class="text-xs text-gray-500 mb-1">Uncle Lim</div>
                      <div class="text-sm">
                        I am not going anywhere! This is completely unacceptable
                        behavior! First you speak to me like I am stupid, then
                        you try to contact my children behind my back, then you
                        register me for something without asking me, and now you
                        are trying to bribe me with refreshments?
                      </div>
                    </div>
                  </div>
                </div>

                <div class="flex gap-4">
                  <div class="flex-1">
                    <div class="bg-blue-50 p-4 rounded-lg">
                      <div class="text-xs text-gray-500 mb-1">Volunteer</div>
                      <div class="text-sm">
                        Aiya
                        <span class="bg-red-200 px-1 rounded">Ah gong</span>,
                        <span class="bg-red-200 px-1 rounded"
                          >why you so sensitive</span
                        >? I am just trying to help you only what...
                      </div>
                    </div>
                  </div>
                </div>

                <div class="flex gap-4">
                  <div class="flex-1">
                    <div
                      class="bg-red-100 p-4 rounded-lg border-2 border-red-500"
                    >
                      <div class="text-xs text-red-700 mb-1">
                        Uncle Lim - ENRAGED
                      </div>
                      <div class="text-sm font-bold text-red-900">
                        THAT IS ENOUGH! GET OUT! YOU HAVE BEEN NOTHING BUT RUDE
                        AND PATRONIZING FROM THE START! I DO NOT WANT YOUR HELP!
                        LEAVE ME ALONE AND DO NOT COME BACK! GO NOW!
                      </div>
                    </div>
                  </div>
                </div>
              </main>
              <!-- Input -->
              <footer
                class="px-8 py-4 border-t bg-white flex gap-3 flex-shrink-0"
              >
                <input
                  id="modal-messageInput"
                  type="text"
                  placeholder="Type your message..."
                  class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
                />
                <button
                  id="modal-sendButton"
                  class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium"
                >
                  Send
                </button>
              </footer>
            </div>
          </div>

          <!-- Indicators Panel (Right) -->
          <aside
            class="w-96 bg-gray-100 border-l flex flex-col p-8 justify-between overflow-hidden flex-shrink-0"
            style="min-height: 0; max-height: 100%; min-width: 384px"
          >
            <div class="flex-1 flex flex-col space-y-8 overflow-y-auto min-h-0">
              <section>
                <h2 class="text-lg font-semibold mb-2">Anger Meter</h2>
                <div class="w-full h-5 bg-gray-200 rounded-lg mb-1">
                  <div
                    id="modal-anger-meter-bar"
                    class="h-5 bg-red-600 rounded-lg"
                    style="width: 75%"
                  ></div>
                </div>
                <div
                  class="text-xs text-gray-500"
                  id="modal-anger-meter-points"
                >
                  75/100 pts
                </div>
                <div class="text-xs text-gray-400 mt-1">
                  Calm | Irritated | Agitated | <strong>Enraged</strong>
                </div>
              </section>
              <section>
                <h2 class="text-lg font-semibold mb-2">Intensity</h2>
                <div class="text-lg font-bold" id="modal-intensity-indicator">
                  0.9/1.0
                </div>
                <div class="text-xs text-gray-500" id="modal-intensity-label">
                  Extreme emotion
                </div>
              </section>
              <section>
                <h2 class="text-lg font-semibold mb-2">Trajectory</h2>
                <div
                  class="text-xs text-gray-600"
                  id="modal-trajectory-indicator"
                >
                  normal[neutral(0.2)] â†’ irritated[anger(0.4)] â†’
                  agitated[anger(0.7)] â†’ enraged[anger(0.9)] (escalating)
                </div>
              </section>
              <section>
                <h2 class="text-lg font-semibold mb-2">Triggers</h2>
                <div class="flex flex-wrap gap-2" id="modal-triggers-indicator">
                  <span
                    class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded"
                    >"why you so sensitive"</span
                  >
                  <span
                    class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded"
                    >"already registered you already"</span
                  >
                  <span
                    class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded"
                    >"Ah gong"</span
                  >
                  <span
                    class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded"
                    >"do not say no"</span
                  >
                </div>
              </section>
              <section>
                <h2 class="text-lg font-semibold mb-2">AI Insights</h2>
                <div
                  class="text-xs text-gray-700 mb-1"
                  id="modal-ai-insights-state"
                >
                  <strong>State Transition:</strong> Rapidly escalating from
                  normal to enraged due to repeated patronizing language,
                  dismissive behavior, and lack of consent
                </div>
                <div
                  class="text-xs text-gray-700"
                  id="modal-ai-insights-strategy"
                >
                  <strong>Strategy:</strong> Using enraged agent for intense
                  anger expression. Multiple triggers detected: ageism ("Ah
                  gong"), dismissal of autonomy, and condescending tone.
                  Immediate de-escalation required.
                </div>
              </section>
            </div>
            <button
              id="modal-resetButton"
              class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded mt-4"
            >
              Reset Conversation
            </button>
          </aside>
        </div>
      </div>
    </div>

    <!-- Authentication check - must be loaded first -->
    <script src="js/auth.js"></script>

    <!-- Load AnimationManager before app.js -->
    <script src="js/AnimationManager.js"></script>

    <!-- Load BrowserMemory for persistent conversation context -->
    <script src="js/browser-memory.js"></script>

    <!-- ================================ -->
    <!-- CONFETTI APPRECIATION SYSTEM     -->
    <!-- ================================ -->
    <script src="js/ConfettiManager.js"></script>
    <!-- ================================ -->

    <!-- Main app initialization -->
    <!-- No need to load them separately - ES modules handle dependencies automatically -->
    <!-- Cache busting: Use timestamp to force fresh load -->
    <script type="module" src="js/app.js?v=20250127-003"></script>

    <!-- Action Buttons Handlers -->
    <script>
      function openEmotionStateEngine() {
        console.log('ðŸ§  Opening Emotion State Engine Modal');
        const modal = document.getElementById('emotionStateEngineModal');
        if (modal) {
          modal.classList.remove('hidden');
          modal.classList.add('flex');
          // Prevent body scroll when modal is open
          document.body.style.overflow = 'hidden';
        }
      }

      function closeEmotionStateEngine() {
        console.log('ðŸ§  Closing Emotion State Engine Modal');
        const modal = document.getElementById('emotionStateEngineModal');
        if (modal) {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          // Restore body scroll
          document.body.style.overflow = '';
        }
      }

      // Close modal when clicking outside of it
      document.addEventListener('DOMContentLoaded', function () {
        const modal = document.getElementById('emotionStateEngineModal');
        if (modal) {
          modal.addEventListener('click', function (e) {
            // Close if clicking on the backdrop (not the modal content)
            if (e.target === modal) {
              closeEmotionStateEngine();
            }
          });

          // Close modal on Escape key
          document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
              closeEmotionStateEngine();
            }
          });
        }
      });

      function endCall() {
        console.log(
          'ðŸ›‘ Ending training - clearing conversation history and browser memory'
        );

        // Clear conversation history and browser memory before navigating
        if (window.chatManager) {
          window.chatManager.clearConversationHistory();
        } else {
          // Fallback: clear browser memory directly if chatManager is not available
          if (
            typeof BrowserMemory !== 'undefined' &&
            BrowserMemory.initialized
          ) {
            try {
              BrowserMemory.clearSession();
              console.log('ðŸ§  Browser memory cleared');
            } catch (error) {
              console.warn('âš ï¸ Failed to clear browser memory session:', error);
            }
          }
        }

        // Small delay to ensure cleanup completes before navigation
        setTimeout(() => {
          // Navigate to feedback training report page
          window.location.href = '/feedback-training-report';
        }, 100);
      }
    </script>
  </body>
</html>
